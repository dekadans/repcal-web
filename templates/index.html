{% extends "layout.html" %}

{% block head %}
{{ super() }}

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
    async function getData() {
        const offset = (new Date()).getTimezoneOffset() * -1;
        const response = await fetch('/now?offset=' + offset);
        const data = await response.json();

        return {
            ...parseDate(data._embedded['repcal:date']),
            ...parseTime(data._embedded['repcal:time'])
        };
    }

    function parseDate(api_date) {
        const links = api_date._links['repcal:meta-day'];
        const uiLink = links.find(l => l.name === 'ui');

        return {
            date: api_date.texts.default,
            celebrating: uiLink.title,
            wiki: uiLink.href,
            wiki_api: links.find(l => l.name === 'data').href
        }
    }

    function parseTime(api_time) {
        return {
            hour: api_time.attributes.hour,
            minute: api_time.attributes.minute,
            second: api_time.attributes.second
        };
    }

    document.addEventListener('alpine:init', async () => {
        Alpine.data('now', () => ({
            date: 'Loading...',
            hour: 0,
            minute: 0,
            second: 0,
            celebrating: '...',
            wiki: '#',
            wiki_api: '#',

            init() {
                this.sync();

                setInterval(() => {
                    this.tick();
                }, 864);

                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        this.sync();
                    }
                });
            },

            async sync() {
                Object.assign(this, await getData());
            },

            tick() {
                this.second = (this.second + 1) % 100;

                if (this.second === 0) {
                    this.minute = (this.minute + 1) % 100;

                    if (this.minute === 0) {
                        this.hour = (this.hour + 1) % 10;

                        if (this.hour === 0) {
                            this.sync();
                        }
                    }
                }
            }
        }));
    });
</script>

{% endblock %}
{% block content %}


<div id="app" x-data="now">
    <h1 x-text="date"></h1>
    <h2>
        <span x-text="hour"></span>:<span x-text="minute"></span>:<span x-text="second"></span>
    </h2>

    <div id="celebration">
        <h3>Celebrating <a :href="wiki" target="_blank"><span x-text="celebrating"></span></a>.</h3>
        <hr>
        <div id="info">
            <p>
                This page shows the current date and time using the systems implemented by the French First Republic.
                The calendar was used from 1793 to 1805 and decimal time for about a year between 1794 and 1795.
            </p>
            <p>
                Each day observes an everyday object&mdash;like a plant, animal or tool&mdash;common in the rural economy of France
                in the 18th century.
            </p>
        </div>
    </div>
</div>

{% endblock %}